<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„. Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª">
    <meta name="keywords" content="Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©, Ø¹Ù…Ù„Ø§Ø¡, Ø¥Ø¯Ø§Ø±Ø©, Ù…Ø­Ø§Ø³Ø¨Ø©, ÙÙˆØ§ØªÙŠØ±">
    <meta name="author" content="Minavir">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #f39c12;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .online-indicator {
            background: #27ae60;
        }
        
        .backup-reminder {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            max-width: 300px;
        }
        
        @media (max-width: 768px) {
            .backup-reminder {
                bottom: 80px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="offline-indicator">
        ğŸŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    </div>

    <!-- Backup Reminder -->
    <div id="backupReminder" class="backup-reminder">
        <div class="flex items-center justify-between">
            <div>
                <p class="font-semibold">âš ï¸ ØªØ°ÙƒÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</p>
                <p class="text-sm">Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 7 Ø£ÙŠØ§Ù…</p>
            </div>
            <button onclick="hideBackupReminder()" class="text-white hover:text-gray-200 ml-2">âœ•</button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="text-4xl">ğŸ’°</div>
                    <div>
                        <h1 class="text-3xl font-bold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
                        <p class="text-blue-100">ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-blue-100">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                    <p id="lastUpdate" class="text-lg font-semibold">--</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Personal Summary -->
    <section class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-8">
        <div class="container mx-auto px-4">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <span class="ml-2">ğŸ“Š</span>
                Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ø®ØµÙŠ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white bg-opacity-20 rounded-lg p-6 text-center">
                    <div class="text-4xl mb-3">ğŸ’°</div>
                    <h3 class="text-xl font-semibold mb-2">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†ÙŠ (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©)</h3>
                    <p id="totalOwed" class="text-4xl font-bold">0 Ø¬Ù†ÙŠÙ‡</p>
                    <p class="text-sm opacity-80 mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ø¹Ù„ÙŠÙƒ Ù…Ù† Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</p>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-6 text-center">
                    <div class="text-4xl mb-3">ğŸ’µ</div>
                    <h3 class="text-xl font-semibold mb-2">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„ÙŠ (Ù…Ø³ØªØ­Ù‚Ø§Øª)</h3>
                    <p id="totalDue" class="text-4xl font-bold">0 Ø¬Ù†ÙŠÙ‡</p>
                    <p class="text-sm opacity-80 mt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ Ù„Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Statistics Cards -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="text-4xl mb-3">ğŸ‘¥</div>
                    <h3 class="text-lg font-semibold text-gray-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <p id="totalCustomers" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="text-4xl mb-3">ğŸ’¸</div>
                    <h3 class="text-lg font-semibold text-gray-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</h3>
                    <p id="totalDebt" class="text-3xl font-bold text-red-600">0 Ø¬Ù†ÙŠÙ‡</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="text-4xl mb-3">ğŸ’š</div>
                    <h3 class="text-lg font-semibold text-gray-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h3>
                    <p id="totalPaid" class="text-3xl font-bold text-green-600">0 Ø¬Ù†ÙŠÙ‡</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-shadow">
                    <div class="text-4xl mb-3">âš ï¸</div>
                    <h3 class="text-lg font-semibold text-gray-700">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†</h3>
                    <p id="debtorCount" class="text-3xl font-bold text-orange-600">0</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Add New Customer Form -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="ml-2">ğŸ‘¤</span>
                    ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                </h2>
                
                <form id="customerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <input type="text" id="newCustomerCode" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ù…Ø«Ø§Ù„: C001">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <input type="text" id="newCustomerName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="newCustomerPhone" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <textarea id="newCustomerAddress" rows="2"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                        âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
                    </button>
                </form>
            </div>

            <!-- Add Transaction Form -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="ml-2">ğŸ“</span>
                    Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </h2>
                
                <form id="transactionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <div class="relative">
                            <input type="text" id="customerCode" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                            <div id="customerInfo" class="mt-2 p-3 bg-gray-50 rounded hidden">
                                <p id="customerDetails" class="text-sm text-gray-700"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© *</label>
                        <select id="transactionType" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</option>
                            <option value="debt">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</option>
                            <option value="payment">Ø¯ÙØ¹Ø©</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡) *</label>
                        <input type="number" id="amount" required min="0" step="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÙˆØµÙ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                        <textarea id="description" rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                        âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
                    </button>
                </form>
            </div>

            <!-- Customer Search and Tools -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="ml-2">ğŸ”</span>
                    Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <div class="relative">
                            <input type="text" id="quickSearchCode" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹">
                            <button onclick="quickSearch()" 
                                    class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                ğŸ”
                            </button>
                        </div>
                        <div id="quickSearchResult" class="mt-2 hidden"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…</label>
                        <input type="text" id="searchCustomer" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</label>
                        <select id="statusFilter" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                            <option value="debtors">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ† ÙÙ‚Ø·</option>
                            <option value="cleared">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¯Ø¯ÙŠÙ†</option>
                        </select>
                    </div>
                    
                    <div class="space-y-3 pt-4 border-t">
                        <button onclick="createBackup()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                            ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                        </button>
                        
                        <button onclick="exportToExcel()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                            ğŸ“Š ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                        </button>
                        
                        <div class="border-t pt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</label>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <button onclick="importFromExcel()" 
                                    class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                        </div>
                        
                        <button onclick="downloadTemplate()" 
                                class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">
                            ğŸ“‹ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
                        </button>
                        
                        <div class="border-t pt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</label>
                            <input type="file" id="backupFile" accept=".json" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <button onclick="restoreBackup()" 
                                    class="w-full mt-2 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Controls -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="ml-2">ğŸ“‹</span>
                Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="showCustomersPage()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 flex items-center justify-center">
                    <span class="ml-2">ğŸ‘¥</span>
                    Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                </button>
                
                <button onclick="printCurrentReport()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 flex items-center justify-center">
                    <span class="ml-2">ğŸ–¨ï¸</span>
                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                </button>
            </div>
        </div>

        <!-- Customers List -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="ml-2">ğŸ‘¥</span>
                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </h2>
            <div id="customersList" class="space-y-4">
                <!-- Customers will be loaded here -->
            </div>
        </div>

        <!-- Reports Section -->
        <div class="mt-8 space-y-8">
            <!-- General Monthly Report -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="ml-2">ğŸ“Š</span>
                    Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¹Ø§Ù…
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <select id="reportMonth" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                        <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                        <option value="3">Ù…Ø§Ø±Ø³</option>
                        <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                        <option value="5">Ù…Ø§ÙŠÙˆ</option>
                        <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                        <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                        <option value="8">Ø£ØºØ³Ø·Ø³</option>
                        <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                        <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                        <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                        <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                    </select>
                    
                    <select id="reportYear" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- Years will be populated by JavaScript -->
                    </select>
                    
                    <button onclick="generateMonthlyReport()" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                    
                    <button onclick="printMonthlyReport()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>
                
                <div id="monthlyReportContent">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ğŸ“ˆ</div>
                        <p>Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
                    </div>
                </div>
            </div>

            <!-- Individual Customer Reports -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="ml-2">ğŸ‘¤</span>
                    ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ÙØ±Ø¯ÙŠØ©
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <select id="customerReportCode" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                        <!-- Customers will be populated by JavaScript -->
                    </select>
                    
                    <select id="customerReportType" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="monthly">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</option>
                        <option value="yearly">ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ</option>
                        <option value="full">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</option>
                    </select>
                    
                    <select id="customerReportMonth" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                        <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                        <option value="3">Ù…Ø§Ø±Ø³</option>
                        <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                        <option value="5">Ù…Ø§ÙŠÙˆ</option>
                        <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                        <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
                        <option value="8">Ø£ØºØ³Ø·Ø³</option>
                        <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                        <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
                        <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                        <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
                    </select>
                    
                    <select id="customerReportYear" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- Years will be populated by JavaScript -->
                    </select>
                    
                    <button onclick="generateCustomerReport()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        ğŸ“‹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="printCustomerReport()" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="ml-2">ğŸ–¨ï¸</span>
                        Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„
                    </button>
                    
                    <button onclick="exportCustomerReport()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="ml-2">ğŸ“Š</span>
                        ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                    </button>
                    
                    <button onclick="emailCustomerReport()" 
                            class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span class="ml-2">ğŸ“§</span>
                        Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                    </button>
                </div>
                
                <div id="customerReportContent">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ğŸ‘¤</div>
                        <p>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Customers Management Page (Hidden by default) -->
    <div id="customersPage" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
        <div class="container mx-auto px-4 py-6">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold flex items-center">
                            <span class="ml-3">ğŸ‘¥</span>
                            Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                        </h1>
                        <p class="text-blue-100 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</p>
                    </div>
                    <button onclick="hideCustomersPage()" 
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-lg transition duration-200 flex items-center">
                        <span class="ml-2">ğŸ </span>
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø«</label>
                        <input type="text" id="customersPageSearch" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
                    </div>
                    
                    <!-- Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÙÙ„ØªØ±Ø©</label>
                        <select id="customersPageFilter" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                            <option value="debtors">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ† ÙÙ‚Ø·</option>
                            <option value="cleared">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¯Ø¯ÙŠÙ†</option>
                        </select>
                    </div>
                    
                    <!-- Sort -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
                        <select id="customersPageSort" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
                            <option value="code">Ø§Ù„ÙƒÙˆØ¯</option>
                            <option value="balance">Ø§Ù„Ø±ØµÙŠØ¯</option>
                            <option value="date">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 items-center justify-between border-t pt-4">
                    <div class="flex flex-wrap gap-3">
                        <button onclick="selectAllCustomers()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                            <span class="ml-2">â˜‘ï¸</span>
                            ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        
                        <button onclick="deselectAllCustomers()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                            <span class="ml-2">â¬œ</span>
                            Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                        </button>
                        
                        <button onclick="deleteSelectedCustomers()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                            <span class="ml-2">ğŸ—‘ï¸</span>
                            Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="exportSelectedCustomers()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                            <span class="ml-2">ğŸ“Š</span>
                            ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
                        </button>
                        
                        <button onclick="printSelectedCustomers()" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                            <span class="ml-2">ğŸ–¨ï¸</span>
                            Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl mb-2">ğŸ‘¥</div>
                    <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                    <p id="customersPageTotalCount" class="text-xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl mb-2">âš ï¸</div>
                    <p class="text-sm text-gray-600">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†</p>
                    <p id="customersPageDebtorCount" class="text-xl font-bold text-red-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl mb-2">âœ…</div>
                    <p class="text-sm text-gray-600">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¯Ø¯ÙŠÙ†</p>
                    <p id="customersPageClearedCount" class="text-xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 text-center">
                    <div class="text-2xl mb-2">â˜‘ï¸</div>
                    <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    <p id="customersPageSelectedCount" class="text-xl font-bold text-purple-600">0</p>
                </div>
            </div>

            <!-- Customers List -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div id="customersPageList" class="space-y-3">
                    <!-- Customers will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <div class="flex items-center justify-center mb-4">
                <div class="text-3xl ml-3">ğŸ’°</div>
                <h3 class="text-xl font-bold">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
            </div>
            <p class="text-gray-300 mb-2">ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</p>
            <p class="text-sm text-gray-400">
                ØªØ·ÙˆÙŠØ±: <span class="font-semibold text-blue-300">Minavir</span> | 
                Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
            </p>
            <div class="mt-4 text-xs text-gray-500">
                <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ÙŠÙ†Ø§ÙŠØ± 2025</p>
                <p>Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</p>
            </div>
        </div>
    </footer>

    <!-- Transaction History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
        <span id="successText">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="loading mb-4"></div>
            <p class="text-gray-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>
    </div>

    <script>
        // Data storage
        let customers = JSON.parse(localStorage.getItem('customersData')) || {};
        let transactions = JSON.parse(localStorage.getItem('transactionsData')) || [];
        let selectedCustomers = new Set();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            updateStatistics();
            renderCustomersList();
            setupEventListeners();
            populateYearOptions();
            populateCustomerOptions();
            setCurrentMonthYear();
            updateLastUpdateTime();
            checkConnectionStatus();
            checkBackupReminder();
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
        }

        function setupEventListeners() {
            document.getElementById('customerForm').addEventListener('submit', handleNewCustomer);
            document.getElementById('transactionForm').addEventListener('submit', handleTransaction);
            document.getElementById('customerCode').addEventListener('input', validateCustomerCode);
            document.getElementById('searchCustomer').addEventListener('input', filterCustomers);
            document.getElementById('statusFilter').addEventListener('change', filterCustomers);
            document.getElementById('quickSearchCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    quickSearch();
                }
            });

            // Connection status monitoring
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        }

        function checkConnectionStatus() {
            updateConnectionStatus();
            setInterval(updateConnectionStatus, 30000);
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                statusEl.textContent = 'ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                statusEl.classList.add('online-indicator');
                statusEl.style.display = 'none';
            } else {
                statusEl.textContent = 'ğŸŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                statusEl.classList.remove('online-indicator');
                statusEl.style.display = 'block';
            }
        }

        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                const lastBackupDate = new Date(lastBackup);
                const now = new Date();
                const daysDiff = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 7) {
                    document.getElementById('backupReminder').style.display = 'block';
                }
            } else {
                document.getElementById('backupReminder').style.display = 'block';
            }
        }

        function hideBackupReminder() {
            document.getElementById('backupReminder').style.display = 'none';
        }

        function autoSave() {
            try {
                localStorage.setItem('customersData', JSON.stringify(customers));
                localStorage.setItem('transactionsData', JSON.stringify(transactions));
                localStorage.setItem('lastAutoSave', new Date().toISOString());
                updateLastUpdateTime();
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }

        function updateLastUpdateTime() {
            const lastUpdate = localStorage.getItem('lastAutoSave');
            if (lastUpdate) {
                const date = new Date(lastUpdate);
                document.getElementById('lastUpdate').textContent = date.toLocaleString('ar-EG');
            } else {
                document.getElementById('lastUpdate').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯';
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }

        function handleNewCustomer(e) {
            e.preventDefault();
            
            const customerCode = document.getElementById('newCustomerCode').value.trim().toUpperCase();
            const customerName = document.getElementById('newCustomerName').value.trim();
            const customerPhone = document.getElementById('newCustomerPhone').value.trim();
            const customerAddress = document.getElementById('newCustomerAddress').value.trim();
            
            if (!customerCode || !customerName) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            if (customers[customerCode]) {
                alert('ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„! ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ù…Ø®ØªÙ„Ù');
                return;
            }

            showLoading();

            customers[customerCode] = {
                code: customerCode,
                name: customerName,
                phone: customerPhone,
                address: customerAddress,
                totalDebt: 0,
                totalPaid: 0,
                balance: 0,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('customersData', JSON.stringify(customers));

            document.getElementById('customerForm').reset();
            updateStatistics();
            renderCustomersList();
            hideLoading();
            showSuccessMessage(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ${customerName} Ø¨ÙƒÙˆØ¯ ${customerCode} Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function handleTransaction(e) {
            e.preventDefault();
            
            const customerCode = document.getElementById('customerCode').value.trim().toUpperCase();
            const transactionType = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();
            
            if (!customerCode || !transactionType || !amount) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            if (!customers[customerCode]) {
                alert('ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯');
                return;
            }

            showLoading();

            const transaction = {
                id: Date.now(),
                customerCode: customerCode,
                customerName: customers[customerCode].name,
                type: transactionType,
                amount: amount,
                description: description,
                date: new Date().toISOString(),
                timestamp: new Date().toLocaleString('ar-EG')
            };

            if (transactionType === 'debt') {
                customers[customerCode].totalDebt += amount;
                customers[customerCode].balance += amount;
            } else if (transactionType === 'payment') {
                customers[customerCode].totalPaid += amount;
                customers[customerCode].balance -= amount;
                if (customers[customerCode].balance < 0) {
                    customers[customerCode].balance = 0;
                }
            }

            transactions.push(transaction);

            localStorage.setItem('customersData', JSON.stringify(customers));
            localStorage.setItem('transactionsData', JSON.stringify(transactions));

            document.getElementById('transactionForm').reset();
            document.getElementById('customerInfo').classList.add('hidden');

            updateStatistics();
            renderCustomersList();
            populateCustomerOptions();
            hideLoading();
            showSuccessMessage(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${transactionType === 'debt' ? 'Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø§Ù„Ø¯ÙØ¹Ø©'} Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function validateCustomerCode() {
            const customerCode = document.getElementById('customerCode').value.trim().toUpperCase();
            const customerInfo = document.getElementById('customerInfo');
            const customerDetails = document.getElementById('customerDetails');
            
            if (customerCode && customers[customerCode]) {
                const customer = customers[customerCode];
                customerDetails.innerHTML = `
                    <strong>${customer.name}</strong><br>
                    ${customer.phone ? `ğŸ“ ${customer.phone}<br>` : ''}
                    ${customer.address ? `ğŸ“ ${customer.address}<br>` : ''}
                    <span class="text-sm">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="${customer.balance > 0 ? 'text-red-600' : 'text-green-600'} font-semibold">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span></span>
                `;
                customerInfo.classList.remove('hidden');
            } else {
                customerInfo.classList.add('hidden');
            }
        }

        function updateStatistics() {
            const customerCodes = Object.keys(customers);
            const totalCustomers = customerCodes.length;
            let totalDebt = 0;
            let totalPaid = 0;
            let debtorCount = 0;
            let totalOwed = 0;
            let totalDue = 0;

            customerCodes.forEach(code => {
                const customer = customers[code];
                totalDebt += customer.totalDebt;
                totalPaid += customer.totalPaid;
                
                if (customer.balance > 0) {
                    debtorCount++;
                    totalDue += customer.balance;
                } else if (customer.balance < 0) {
                    totalOwed += Math.abs(customer.balance);
                }
            });

            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('totalDebt').textContent = `${totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
            document.getElementById('totalPaid').textContent = `${totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
            document.getElementById('debtorCount').textContent = debtorCount;
            document.getElementById('totalOwed').textContent = `${totalOwed.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
            document.getElementById('totalDue').textContent = `${totalDue.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
        }

        function renderCustomersList() {
            const container = document.getElementById('customersList');
            const customerCodes = Object.keys(customers);

            if (customerCodes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                        <p class="text-sm">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù…Ø¹Ø§Ù…Ù„Ø©</p>
                    </div>
                `;
                return;
            }

            const customersHTML = customerCodes.map(code => {
                const customer = customers[code];
                const statusColor = customer.balance > 0 ? 'text-red-600' : 'text-green-600';
                const statusIcon = customer.balance > 0 ? 'âš ï¸' : 'âœ…';
                const statusText = customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯';

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow fade-in">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-semibold text-gray-800">${customer.name}</h3>
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">${customer.code}</span>
                                </div>
                                ${customer.phone ? `<p class="text-sm text-gray-600 mb-1">ğŸ“ ${customer.phone}</p>` : ''}
                                ${customer.address ? `<p class="text-sm text-gray-600 mb-2">ğŸ“ ${customer.address}</p>` : ''}
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©:</span>
                                        <p class="font-semibold text-red-600">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                                        <p class="font-semibold text-green-600">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                                        <p class="font-semibold ${statusColor}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                                        <p class="font-semibold ${statusColor}">${statusIcon} ${statusText}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 mr-4">
                                <button onclick="showCustomerHistory('${code}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                    ğŸ“Š Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                                </button>
                                <button onclick="deleteCustomer('${code}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                    ğŸ—‘ï¸ Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = customersHTML;
        }

        function quickSearch() {
            const searchCode = document.getElementById('quickSearchCode').value.trim().toUpperCase();
            const resultDiv = document.getElementById('quickSearchResult');
            
            if (!searchCode) {
                resultDiv.classList.add('hidden');
                return;
            }
            
            if (customers[searchCode]) {
                const customer = customers[searchCode];
                const statusColor = customer.balance > 0 ? 'text-red-600' : 'text-green-600';
                const statusIcon = customer.balance > 0 ? 'âš ï¸' : 'âœ…';
                
                resultDiv.innerHTML = `
                    <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-lg">${customer.name}</h4>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${customer.code}</span>
                            </div>
                            <span class="${statusColor} text-lg">${statusIcon}</span>
                        </div>
                        ${customer.phone ? `<p class="text-sm text-gray-600 mb-1">ğŸ“ ${customer.phone}</p>` : ''}
                        ${customer.address ? `<p class="text-sm text-gray-600 mb-2">ğŸ“ ${customer.address}</p>` : ''}
                        <div class="grid grid-cols-3 gap-3 text-sm">
                            <div class="text-center">
                                <p class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</p>
                                <p class="font-bold text-red-600">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                <p class="font-bold text-green-600">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                                <p class="font-bold ${statusColor}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                            </div>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="showCustomerHistory('${searchCode}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                ğŸ“Š Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
                            </button>
                            <button onclick="document.getElementById('customerCode').value='${searchCode}'; validateCustomerCode();" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                ğŸ’° Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©
                            </button>
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <p class="text-red-600">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙŠÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</p>
                        <p class="text-sm text-gray-600 mt-1">ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }

        function showCustomerHistory(customerCode) {
            const customer = customers[customerCode];
            const customerTransactions = transactions.filter(t => t.customerCode === customerCode || t.customerName === customer.name);
            
            document.getElementById('modalTitle').textContent = `Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ - ${customer.name} (${customerCode})`;
            
            let historyHTML = `
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-lg mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</p>
                            <p class="text-xl font-bold text-red-600">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                            <p class="text-xl font-bold text-green-600">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                            <p class="text-xl font-bold ${customer.balance > 0 ? 'text-red-600' : 'text-green-600'}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-semibold text-lg mb-4">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4>
            `;

            if (customerTransactions.length === 0) {
                historyHTML += '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
            } else {
                historyHTML += '<div class="space-y-3">';
                customerTransactions.reverse().forEach(transaction => {
                    const typeIcon = transaction.type === 'debt' ? 'ğŸ’¸' : 'ğŸ’š';
                    const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                    const amountColor = transaction.type === 'debt' ? 'text-red-600' : 'text-green-600';
                    
                    historyHTML += `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">${typeIcon}</span>
                                        <span class="font-semibold">${typeText}</span>
                                        <span class="text-sm text-gray-500">${transaction.timestamp}</span>
                                    </div>
                                    <p class="text-lg font-bold ${amountColor}">${transaction.amount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    ${transaction.description ? `<p class="text-sm text-gray-600 mt-1">${transaction.description}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                historyHTML += '</div>';
            }

            document.getElementById('modalContent').innerHTML = historyHTML;
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        }

        function deleteCustomer(customerCode) {
            const customer = customers[customerCode];
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}" (${customerCode}) ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`)) {
                delete customers[customerCode];
                transactions = transactions.filter(t => t.customerCode !== customerCode && t.customerName !== customer.name);
                
                localStorage.setItem('customersData', JSON.stringify(customers));
                localStorage.setItem('transactionsData', JSON.stringify(transactions));
                
                updateStatistics();
                renderCustomersList();
                showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const customerCards = document.querySelectorAll('#customersList > div');
            
            customerCards.forEach(card => {
                if (card.querySelector('h3')) {
                    const customerName = card.querySelector('h3').textContent.toLowerCase();
                    const customerCode = card.querySelector('.bg-blue-100').textContent.toLowerCase();
                    const balanceElement = card.querySelector('.font-semibold.text-red-600, .font-semibold.text-green-600');
                    const balance = balanceElement ? parseFloat(balanceElement.textContent) : 0;
                    
                    let showCard = true;
                    
                    if (searchTerm && !customerName.includes(searchTerm) && !customerCode.includes(searchTerm)) {
                        showCard = false;
                    }
                    
                    if (statusFilter === 'debtors' && balance <= 0) {
                        showCard = false;
                    } else if (statusFilter === 'cleared' && balance > 0) {
                        showCard = false;
                    }
                    
                    card.style.display = showCard ? 'block' : 'none';
                }
            });
        }

        function populateYearOptions() {
            const yearSelects = ['reportYear', 'customerReportYear'];
            const currentYear = new Date().getFullYear();
            
            yearSelects.forEach(selectId => {
                const yearSelect = document.getElementById(selectId);
                if (yearSelect) {
                    yearSelect.innerHTML = '';
                    
                    for (let year = 2020; year <= currentYear + 5; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) {
                            option.selected = true;
                        }
                        yearSelect.appendChild(option);
                    }
                }
            });
        }

        function populateCustomerOptions() {
            const customerSelect = document.getElementById('customerReportCode');
            if (!customerSelect) return;
            
            customerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</option>';
            
            Object.keys(customers).sort().forEach(code => {
                const customer = customers[code];
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${customer.name} (${code})`;
                customerSelect.appendChild(option);
            });
        }

        function setCurrentMonthYear() {
            const now = new Date();
            document.getElementById('reportMonth').value = now.getMonth() + 1;
            document.getElementById('customerReportMonth').value = now.getMonth() + 1;
        }

        function generateCustomerReport() {
            const customerCode = document.getElementById('customerReportCode').value;
            const reportType = document.getElementById('customerReportType').value;
            const selectedMonth = parseInt(document.getElementById('customerReportMonth').value);
            const selectedYear = parseInt(document.getElementById('customerReportYear').value);
            
            if (!customerCode) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (!customers[customerCode]) {
                alert('Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            const customer = customers[customerCode];
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            let customerTransactions = transactions.filter(t => 
                t.customerCode === customerCode || t.customerName === customer.name
            );
            
            // Filter based on report type
            if (reportType === 'monthly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionMonth = transactionDate.getMonth() + 1;
                    const transactionYear = transactionDate.getFullYear();
                    return transactionMonth === selectedMonth && transactionYear === selectedYear;
                });
            } else if (reportType === 'yearly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionYear = transactionDate.getFullYear();
                    return transactionYear === selectedYear;
                });
            }
            // For 'full' type, we use all transactions
            
            // Calculate statistics
            let totalDebt = 0;
            let totalPayments = 0;
            const monthlyBreakdown = {};
            
            customerTransactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const monthKey = `${transactionDate.getFullYear()}-${transactionDate.getMonth() + 1}`;
                
                if (!monthlyBreakdown[monthKey]) {
                    monthlyBreakdown[monthKey] = {
                        month: transactionDate.getMonth() + 1,
                        year: transactionDate.getFullYear(),
                        debt: 0,
                        payments: 0,
                        transactions: []
                    };
                }
                
                monthlyBreakdown[monthKey].transactions.push(transaction);
                
                if (transaction.type === 'debt') {
                    totalDebt += transaction.amount;
                    monthlyBreakdown[monthKey].debt += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                    monthlyBreakdown[monthKey].payments += transaction.amount;
                }
            });
            
            const netAmount = totalDebt - totalPayments;
            
            // Generate report title
            let reportTitle = '';
            if (reportType === 'monthly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (reportType === 'yearly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ - ${selectedYear}`;
            } else {
                reportTitle = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„';
            }
            
            // Generate report HTML
            let reportHTML = `
                <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">${reportTitle}</h3>
                            <p class="text-lg text-purple-700 font-semibold">${customer.name} (${customer.code})</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl mb-2">ğŸ‘¤</div>
                            <p class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</p>
                            <p class="font-semibold">${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>
                    </div>
                    
                    ${customer.phone ? `<p class="text-sm text-gray-600 mb-1">ğŸ“ ${customer.phone}</p>` : ''}
                    ${customer.address ? `<p class="text-sm text-gray-600 mb-3">ğŸ“ ${customer.address}</p>` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl mb-2">ğŸ’¸</div>
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</p>
                            <p class="text-xl font-bold text-red-600">${totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl mb-2">ğŸ’š</div>
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
                            <p class="text-xl font-bold text-green-600">${totalPayments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl mb-2">ğŸ“Š</div>
                            <p class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                            <p class="text-xl font-bold ${netAmount >= 0 ? 'text-red-600' : 'text-green-600'}">${netAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl mb-2">ğŸ“‹</div>
                            <p class="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>
                            <p class="text-xl font-bold text-blue-600">${customerTransactions.length}</p>
                        </div>
                    </div>
                </div>
            `;
            
            if (customerTransactions.length === 0) {
                reportHTML += `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-6xl mb-4">ğŸ“…</div>
                        <p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                        <p class="text-sm mt-2">ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>
                    </div>
                `;
            } else {
                // Monthly breakdown for yearly and full reports
                if (reportType !== 'monthly' && Object.keys(monthlyBreakdown).length > 1) {
                    reportHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    `;
                    
                    Object.keys(monthlyBreakdown).sort().forEach(monthKey => {
                        const monthData = monthlyBreakdown[monthKey];
                        const monthNet = monthData.debt - monthData.payments;
                        
                        reportHTML += `
                            <div class="border border-gray-200 rounded-lg p-4 bg-white">
                                <h5 class="font-semibold text-center mb-3">${monthNames[monthData.month]} ${monthData.year}</h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª:</span>
                                        <span class="font-semibold text-red-600">${monthData.debt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Ù…Ø¯ÙÙˆØ¹Ø§Øª:</span>
                                        <span class="font-semibold text-green-600">${monthData.payments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span>Ø§Ù„ØµØ§ÙÙŠ:</span>
                                        <span class="font-bold ${monthNet >= 0 ? 'text-red-600' : 'text-green-600'}">${monthNet.toFixed(2)} Ø¬Ù†ÙŠÙ‡</span>
                                    </div>
                                    <div class="text-center text-xs text-gray-500">
                                        ${monthData.transactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHTML += `</div></div>`;
                }
                
                // Detailed transactions
                reportHTML += `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (${customerTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©)</h4>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                `;
                
                // Sort transactions by date (newest first)
                const sortedTransactions = [...customerTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedTransactions.forEach(transaction => {
                    const typeIcon = transaction.type === 'debt' ? 'ğŸ’¸' : 'ğŸ’š';
                    const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                    const amountColor = transaction.type === 'debt' ? 'text-red-600' : 'text-green-600';
                    
                    reportHTML += `
                        <div class="border border-gray-200 rounded-lg p-3 bg-white">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <span class="text-lg">${typeIcon}</span>
                                    <div>
                                        <span class="font-semibold">${typeText}</span>
                                        <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString('ar-EG')} - ${new Date(transaction.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${amountColor} text-lg">${transaction.amount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                </div>
                            </div>
                            ${transaction.description ? `<p class="text-sm text-gray-600 mt-2 pr-8">${transaction.description}</p>` : ''}
                        </div>
                    `;
                });
                
                reportHTML += `</div></div>`;
                
                // Current balance section
                reportHTML += `
                    <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                                <p class="text-xl font-bold text-red-600">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                                <p class="text-xl font-bold text-green-600">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                                <p class="text-2xl font-bold ${customer.balance > 0 ? 'text-red-600' : 'text-green-600'}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                <p class="text-xs text-gray-500 mt-1">${customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('customerReportContent').innerHTML = reportHTML;
            showSuccessMessage(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${reportTitle} Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customer.name} Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function printCustomerReport() {
            const reportContent = document.getElementById('customerReportContent');
            const customerCode = document.getElementById('customerReportCode').value;
            
            if (!customerCode || !reportContent.innerHTML.includes('Ø§Ù„ØªÙ‚Ø±ÙŠØ±')) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
                return;
            }
            
            const customer = customers[customerCode];
            const reportType = document.getElementById('customerReportType').value;
            const selectedMonth = parseInt(document.getElementById('customerReportMonth').value);
            const selectedYear = parseInt(document.getElementById('customerReportYear').value);
            
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            let customerTransactions = transactions.filter(t => 
                t.customerCode === customerCode || t.customerName === customer.name
            );
            
            // Filter based on report type
            if (reportType === 'monthly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionMonth = transactionDate.getMonth() + 1;
                    const transactionYear = transactionDate.getFullYear();
                    return transactionMonth === selectedMonth && transactionYear === selectedYear;
                });
            } else if (reportType === 'yearly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionYear = transactionDate.getFullYear();
                    return transactionYear === selectedYear;
                });
            }
            
            // Calculate statistics
            let totalDebt = 0;
            let totalPayments = 0;
            
            customerTransactions.forEach(transaction => {
                if (transaction.type === 'debt') {
                    totalDebt += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
            });
            
            const netAmount = totalDebt - totalPayments;
            
            // Generate report title
            let reportTitle = '';
            let periodText = '';
            if (reportType === 'monthly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthNames[selectedMonth]} ${selectedYear}`;
                periodText = `${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (reportType === 'yearly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ - ${selectedYear}`;
                periodText = `Ø§Ù„Ø¹Ø§Ù… ${selectedYear}`;
            } else {
                reportTitle = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„';
                periodText = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª';
            }
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTitle} - ${customer.name}</title>
                    <style>
                        body {
                            font-family: 'Arial', 'Tahoma', sans-serif;
                            margin: 10px;
                            color: #000;
                            direction: rtl;
                            font-size: 11px;
                            line-height: 1.3;
                            background: white;
                        }
                        
                        /* Excel-style table formatting */
                        .excel-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            border: 2px solid #000;
                        }
                        
                        .excel-table th {
                            background: linear-gradient(to bottom, #70AD47, #548235);
                            color: white;
                            font-weight: bold;
                            padding: 8px 6px;
                            border: 1px solid #000;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .excel-table td {
                            padding: 6px 8px;
                            border: 1px solid #000;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .excel-table .row-number {
                            background: #D9E2F3;
                            font-weight: bold;
                            width: 30px;
                            text-align: center;
                        }
                        
                        .excel-table .total-row {
                            background: #FFF2CC;
                            font-weight: bold;
                            border-top: 2px solid #000;
                        }
                        
                        .excel-table .customer-row {
                            background: #E2EFDA;
                            font-weight: bold;
                        }
                        
                        .header-section {
                            background: linear-gradient(to right, #70AD47, #4472C4);
                            color: white;
                            padding: 15px;
                            margin-bottom: 20px;
                            border: 2px solid #000;
                            text-align: center;
                        }
                        
                        .header-section h1 {
                            margin: 0 0 8px 0;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        
                        .header-section p {
                            margin: 3px 0;
                            font-size: 12px;
                        }
                        
                        .customer-info-section {
                            background: #F8F9FA;
                            border: 2px solid #70AD47;
                            padding: 15px;
                            margin: 15px 0;
                            border-radius: 5px;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            margin: 15px 0;
                        }
                        
                        .summary-card {
                            border: 2px solid #000;
                            padding: 10px;
                            text-align: center;
                            border-radius: 5px;
                        }
                        
                        .summary-card.debt {
                            background: linear-gradient(to bottom, #FFE6E6, #FFCCCC);
                        }
                        
                        .summary-card.payment {
                            background: linear-gradient(to bottom, #E6F7E6, #CCEECC);
                        }
                        
                        .summary-card.net {
                            background: linear-gradient(to bottom, #E6F3FF, #CCE7FF);
                        }
                        
                        .summary-card.count {
                            background: linear-gradient(to bottom, #FFF0E6, #FFE1CC);
                        }
                        
                        .summary-card h3 {
                            margin: 0 0 5px 0;
                            font-size: 10px;
                            color: #333;
                        }
                        
                        .summary-card .value {
                            font-size: 14px;
                            font-weight: bold;
                            margin: 5px 0;
                        }
                        
                        .debt-value { color: #C5504B; }
                        .payment-value { color: #70AD47; }
                        .net-positive { color: #C5504B; }
                        .net-negative { color: #70AD47; }
                        .count-value { color: #4472C4; }
                        
                        .section-title {
                            background: linear-gradient(to right, #70AD47, #4472C4);
                            color: white;
                            padding: 8px 15px;
                            margin: 20px 0 10px 0;
                            font-weight: bold;
                            font-size: 12px;
                            border: 1px solid #000;
                        }
                        
                        .current-balance-section {
                            background: #F0F8FF;
                            border: 2px solid #4472C4;
                            padding: 15px;
                            margin: 20px 0;
                            border-radius: 5px;
                        }
                        
                        .footer-section {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 9px;
                            color: #666;
                            border-top: 2px solid #000;
                            padding-top: 10px;
                            background: #F8F9FA;
                        }
                        
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header Section -->
                    <div class="header-section">
                        <h1>ğŸ‘¤ ${reportTitle}</h1>
                        <p><strong>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„</strong></p>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-EG')} | Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</p>
                    </div>
                    
                    <!-- Customer Information -->
                    <div class="customer-info-section">
                        <h2 style="color: #70AD47; margin: 0 0 10px 0; font-size: 14px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer.name}</p>
                                <p><strong>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer.code}</p>
                            </div>
                            <div>
                                ${customer.phone ? `<p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${customer.phone}</p>` : ''}
                                ${customer.address ? `<p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${customer.address}</p>` : ''}
                                <p><strong>ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${periodText}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="section-title">ğŸ“Š Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</div>
                    
                    <div class="summary-grid">
                        <div class="summary-card debt">
                            <h3>ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</h3>
                            <div class="value debt-value">${totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                        </div>
                        
                        <div class="summary-card payment">
                            <h3>ğŸ’š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                            <div class="value payment-value">${totalPayments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                        </div>
                        
                        <div class="summary-card net">
                            <h3>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                            <div class="value ${netAmount >= 0 ? 'net-positive' : 'net-negative'}">${netAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                        </div>
                        
                        <div class="summary-card count">
                            <h3>ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
                            <div class="value count-value">${customerTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                        </div>
                    </div>
                    
                    ${customerTransactions.length > 0 ? `
                    <!-- Detailed Transactions -->
                    <div class="section-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (${customerTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©)</div>
                    
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="row-number">#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerTransactions.sort((a, b) => new Date(a.date) - new Date(b.date)).map((transaction, index) => {
                                const date = new Date(transaction.date);
                                const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                                const typeClass = transaction.type === 'debt' ? 'debt-value' : 'payment-value';
                                const typeIcon = transaction.type === 'debt' ? 'ğŸ’¸' : 'ğŸ’š';
                                
                                // Calculate running balance
                                let runningBalance = 0;
                                for (let i = 0; i <= index; i++) {
                                    const t = customerTransactions.sort((a, b) => new Date(a.date) - new Date(b.date))[i];
                                    if (t.type === 'debt') {
                                        runningBalance += t.amount;
                                    } else {
                                        runningBalance -= t.amount;
                                    }
                                }
                                
                                return `
                                    <tr>
                                        <td class="row-number">${index + 1}</td>
                                        <td>${date.toLocaleDateString('ar-EG')}</td>
                                        <td>${date.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</td>
                                        <td class="${typeClass}">${typeIcon} ${typeText}</td>
                                        <td class="${typeClass}"><strong>${transaction.amount.toFixed(2)}</strong></td>
                                        <td style="text-align: right; font-size: 9px;">${transaction.description || '-'}</td>
                                        <td class="${runningBalance >= 0 ? 'debt-value' : 'payment-value'}"><strong>${runningBalance.toFixed(2)}</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</strong></td>
                                <td class="${netAmount >= 0 ? 'debt-value' : 'payment-value'}"><strong>${Math.abs(netAmount).toFixed(2)}</strong></td>
                                <td><strong>${customerTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©</strong></td>
                                <td class="${netAmount >= 0 ? 'debt-value' : 'payment-value'}"><strong>${netAmount.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    ` : `
                    <div style="text-align: center; padding: 40px; background: #F8F9FA; border: 2px solid #ddd; margin: 20px 0;">
                        <h3 style="color: #666;">ğŸ“… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h3>
                        <p>Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customer.name} ÙÙŠ ${periodText}</p>
                    </div>
                    `}
                    
                    <!-- Current Balance Section -->
                    <div class="current-balance-section">
                        <h3 style="color: #4472C4; margin: 0 0 15px 0; font-size: 14px;">ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</h3>
                        <div class="summary-grid">
                            <div class="summary-card debt">
                                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                                <div class="value debt-value">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            
                            <div class="summary-card payment">
                                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                                <div class="value payment-value">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            
                            <div class="summary-card net">
                                <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>
                                <div class="value ${customer.balance > 0 ? 'net-positive' : 'net-negative'}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            
                            <div class="summary-card count">
                                <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                                <div class="value ${customer.balance > 0 ? 'debt-value' : 'payment-value'}">${customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer-section">
                        <p><strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</strong></p>
                        <p>ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„ | Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-EG')}</p>
                        <p>ØªÙ‚Ø±ÙŠØ± Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name} (${customer.code}) - ${periodText}</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showSuccessMessage(`ØªÙ… ÙØªØ­ ØªÙ‚Ø±ÙŠØ± ${customer.name} Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨ØªØµÙ…ÙŠÙ… Excel Ø§Ù„Ù…Ø­ØªØ±Ù`);
        }

        function exportCustomerReport() {
            const customerCode = document.getElementById('customerReportCode').value;
            
            if (!customerCode) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const customer = customers[customerCode];
            const reportType = document.getElementById('customerReportType').value;
            const selectedMonth = parseInt(document.getElementById('customerReportMonth').value);
            const selectedYear = parseInt(document.getElementById('customerReportYear').value);
            
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            let customerTransactions = transactions.filter(t => 
                t.customerCode === customerCode || t.customerName === customer.name
            );
            
            // Filter based on report type
            if (reportType === 'monthly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionMonth = transactionDate.getMonth() + 1;
                    const transactionYear = transactionDate.getFullYear();
                    return transactionMonth === selectedMonth && transactionYear === selectedYear;
                });
            } else if (reportType === 'yearly') {
                customerTransactions = customerTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionYear = transactionDate.getFullYear();
                    return transactionYear === selectedYear;
                });
            }
            
            showLoading();
            
            // Generate report title
            let reportTitle = '';
            let periodText = '';
            if (reportType === 'monthly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthNames[selectedMonth]} ${selectedYear}`;
                periodText = `${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (reportType === 'yearly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ - ${selectedYear}`;
                periodText = `Ø§Ù„Ø¹Ø§Ù… ${selectedYear}`;
            } else {
                reportTitle = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„';
                periodText = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª';
            }
            
            const excelData = [
                [`${reportTitle} - ${customer.name}`],
                [`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer.name} (${customer.code})`],
                [`Ø§Ù„ÙØªØ±Ø©: ${periodText}`],
                [`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleString('ar-EG')}`],
                [''],
                ['Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„'],
                ['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', customer.name],
                ['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', customer.code],
                ['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
                ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', customer.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'],
                [''],
                ['Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨'],
                ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', customer.totalDebt],
                ['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ', customer.totalPaid],
                ['Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', customer.balance],
                ['Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯'],
                [''],
                ['ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©'],
                ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙˆÙ‚Øª', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ']
            ];
            
            if (customerTransactions.length > 0) {
                let runningBalance = 0;
                customerTransactions.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(transaction => {
                    const date = new Date(transaction.date);
                    const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                    
                    if (transaction.type === 'debt') {
                        runningBalance += transaction.amount;
                    } else {
                        runningBalance -= transaction.amount;
                    }
                    
                    excelData.push([
                        date.toLocaleDateString('ar-EG'),
                        date.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'}),
                        typeText,
                        transaction.amount,
                        transaction.description || '',
                        runningBalance
                    ]);
                });
                
                const totalDebt = customerTransactions.filter(t => t.type === 'debt').reduce((sum, t) => sum + t.amount, 0);
                const totalPayments = customerTransactions.filter(t => t.type === 'payment').reduce((sum, t) => sum + t.amount, 0);
                
                excelData.push(['']);
                excelData.push(['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª']);
                excelData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø©', totalDebt]);
                excelData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø©', totalPayments]);
                excelData.push(['ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø§Ù„ÙØªØ±Ø©', totalDebt - totalPayments]);
                excelData.push(['Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', customerTransactions.length]);
            } else {
                excelData.push(['Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©']);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `ØªÙ‚Ø±ÙŠØ± ${customer.name}`);
            
            ws['!cols'] = [
                {wch: 15}, {wch: 10}, {wch: 15}, {wch: 12}, {wch: 30}, {wch: 15}
            ];
            
            const fileName = `ØªÙ‚Ø±ÙŠØ±_${customer.name}_${customer.code}_${periodText.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            hideLoading();
            showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± ${customer.name} Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`);
        }

        function emailCustomerReport() {
            const customerCode = document.getElementById('customerReportCode').value;
            
            if (!customerCode) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const customer = customers[customerCode];
            const reportType = document.getElementById('customerReportType').value;
            const selectedMonth = parseInt(document.getElementById('customerReportMonth').value);
            const selectedYear = parseInt(document.getElementById('customerReportYear').value);
            
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            let reportTitle = '';
            let periodText = '';
            if (reportType === 'monthly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - ${monthNames[selectedMonth]} ${selectedYear}`;
                periodText = `${monthNames[selectedMonth]} ${selectedYear}`;
            } else if (reportType === 'yearly') {
                reportTitle = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ - ${selectedYear}`;
                periodText = `Ø§Ù„Ø¹Ø§Ù… ${selectedYear}`;
            } else {
                reportTitle = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„';
                periodText = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª';
            }
            
            const subject = `${reportTitle} - ${customer.name} (${customer.code})`;
            const body = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡

Ù†Ø±Ø³Ù„ Ø¥Ù„ÙŠÙƒÙ… ${reportTitle} Ù„Ù„Ø¹Ù…ÙŠÙ„ ${customer.name} (${customer.code})

ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${periodText}
Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡
Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: ${customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯'}

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-EG')}

Ù…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            window.open(mailtoLink, '_blank');
            showSuccessMessage('ØªÙ… ÙØªØ­ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        }

        function generateMonthlyReport() {
            const selectedMonth = parseInt(document.getElementById('reportMonth').value);
            const selectedYear = parseInt(document.getElementById('reportYear').value);
            
            console.log(`Generating report for: ${selectedMonth}/${selectedYear}`);
            
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            // Filter transactions for the selected month and year with detailed logging
            const monthlyTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const transactionMonth = transactionDate.getMonth() + 1; // JavaScript months are 0-based
                const transactionYear = transactionDate.getFullYear();
                
                const matches = transactionMonth === selectedMonth && transactionYear === selectedYear;
                
                console.log(`Transaction: ${transaction.date} -> Month: ${transactionMonth}, Year: ${transactionYear}, Matches: ${matches}`);
                
                return matches;
            });
            
            console.log(`Found ${monthlyTransactions.length} transactions for ${selectedMonth}/${selectedYear}`);
            
            // Calculate statistics
            let totalDebt = 0;
            let totalPayments = 0;
            const customerActivity = {};
            
            monthlyTransactions.forEach(transaction => {
                if (transaction.type === 'debt') {
                    totalDebt += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
                
                if (!customerActivity[transaction.customerCode]) {
                    customerActivity[transaction.customerCode] = {
                        name: transaction.customerName,
                        debt: 0,
                        payments: 0,
                        transactions: []
                    };
                }
                
                customerActivity[transaction.customerCode].transactions.push(transaction);
                if (transaction.type === 'debt') {
                    customerActivity[transaction.customerCode].debt += transaction.amount;
                } else {
                    customerActivity[transaction.customerCode].payments += transaction.amount;
                }
            });
            
            // Generate report HTML
            let reportHTML = `
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ØªÙ‚Ø±ÙŠØ± ${monthNames[selectedMonth]} ${selectedYear}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-3xl mb-2">ğŸ’¸</div>
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</p>
                            <p class="text-2xl font-bold text-red-600">${totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-2">ğŸ’š</div>
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
                            <p class="text-2xl font-bold text-green-600">${totalPayments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-2">ğŸ“Š</div>
                            <p class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</p>
                            <p class="text-2xl font-bold ${(totalDebt - totalPayments) >= 0 ? 'text-red-600' : 'text-green-600'}">
                                ${(totalDebt - totalPayments).toFixed(2)} Ø¬Ù†ÙŠÙ‡
                            </p>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-2">ğŸ“‹</div>
                            <p class="text-sm text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>
                            <p class="text-2xl font-bold text-blue-600">${monthlyTransactions.length}</p>
                        </div>
                    </div>
                </div>
            `;
            
            if (monthlyTransactions.length === 0) {
                reportHTML += `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-6xl mb-4">ğŸ“…</div>
                        <p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ ${monthNames[selectedMonth]} ${selectedYear}</p>
                        <p class="text-sm mt-2">ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
                    </div>
                `;
            } else {
                // Customer activity section
                if (Object.keys(customerActivity).length > 0) {
                    reportHTML += `
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (${Object.keys(customerActivity).length} Ø¹Ù…ÙŠÙ„)</h4>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                    `;
                    
                    Object.keys(customerActivity).forEach(code => {
                        const activity = customerActivity[code];
                        const netAmount = activity.debt - activity.payments;
                        
                        reportHTML += `
                            <div class="border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-semibold">${activity.name} (${code})</h5>
                                    <span class="text-sm font-bold ${netAmount >= 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${netAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡
                                    </span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <div class="text-center">
                                        <p class="text-gray-600">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</p>
                                        <p class="font-semibold text-red-600">${activity.debt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-gray-600">Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
                                        <p class="font-semibold text-green-600">${activity.payments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-gray-600">Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>
                                        <p class="font-semibold text-blue-600">${activity.transactions.length}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHTML += `</div></div>`;
                }
                
                // Detailed transactions
                reportHTML += `
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                `;
                
                // Sort transactions by date (newest first)
                const sortedTransactions = [...monthlyTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedTransactions.forEach(transaction => {
                    const typeIcon = transaction.type === 'debt' ? 'ğŸ’¸' : 'ğŸ’š';
                    const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                    const amountColor = transaction.type === 'debt' ? 'text-red-600' : 'text-green-600';
                    
                    reportHTML += `
                        <div class="border border-gray-200 rounded p-3 text-sm">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    <span>${typeIcon}</span>
                                    <span class="font-medium">${transaction.customerName} (${transaction.customerCode})</span>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold ${amountColor}">${transaction.amount.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString('ar-EG')}</p>
                                </div>
                            </div>
                            ${transaction.description ? `<p class="text-gray-600 mt-1 text-xs">${transaction.description}</p>` : ''}
                        </div>
                    `;
                });
                
                reportHTML += `</div></div>`;
            }
            
            document.getElementById('monthlyReportContent').innerHTML = reportHTML;
            showSuccessMessage(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± ${monthNames[selectedMonth]} ${selectedYear} Ø¨Ù†Ø¬Ø§Ø­!`);
        }

        function printCurrentReport() {
            const reportContent = document.getElementById('monthlyReportContent');
            
            if (!reportContent.innerHTML.includes('ØªÙ‚Ø±ÙŠØ±')) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
                return;
            }
            
            printMonthlyReport();
        }

        function printMonthlyReport() {
            const reportContent = document.getElementById('monthlyReportContent');
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);
            
            const monthNames = [
                '', 'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            if (!reportContent.innerHTML.includes('ØªÙ‚Ø±ÙŠØ±')) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Get monthly transactions for detailed report
            const monthlyTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const transactionMonth = transactionDate.getMonth() + 1;
                const transactionYear = transactionDate.getFullYear();
                return transactionMonth === month && transactionYear === year;
            });
            
            // Calculate statistics
            let totalDebt = 0;
            let totalPayments = 0;
            const customerActivity = {};
            
            monthlyTransactions.forEach(transaction => {
                if (transaction.type === 'debt') {
                    totalDebt += transaction.amount;
                } else if (transaction.type === 'payment') {
                    totalPayments += transaction.amount;
                }
                
                if (!customerActivity[transaction.customerCode]) {
                    customerActivity[transaction.customerCode] = {
                        name: transaction.customerName,
                        debt: 0,
                        payments: 0,
                        transactions: []
                    };
                }
                
                customerActivity[transaction.customerCode].transactions.push(transaction);
                if (transaction.type === 'debt') {
                    customerActivity[transaction.customerCode].debt += transaction.amount;
                } else {
                    customerActivity[transaction.customerCode].payments += transaction.amount;
                }
            });
            
            const netMovement = totalDebt - totalPayments;
            const transactionCount = monthlyTransactions.length;
            const activeCustomers = Object.keys(customerActivity).length;
            
            // Calculate percentages and insights
            const debtPercentage = totalPayments > 0 ? ((totalDebt / totalPayments) * 100).toFixed(1) : 0;
            const paymentPercentage = totalDebt > 0 ? ((totalPayments / totalDebt) * 100).toFixed(1) : 0;
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± ${monthNames[month]} ${year} - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</title>
                    <style>
                        body {
                            font-family: 'Arial', 'Tahoma', sans-serif;
                            margin: 10px;
                            color: #000;
                            direction: rtl;
                            font-size: 11px;
                            line-height: 1.3;
                            background: white;
                        }
                        
                        /* Excel-style table formatting */
                        .excel-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            border: 2px solid #000;
                        }
                        
                        .excel-table th {
                            background: linear-gradient(to bottom, #4472C4, #2F5597);
                            color: white;
                            font-weight: bold;
                            padding: 8px 6px;
                            border: 1px solid #000;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .excel-table td {
                            padding: 6px 8px;
                            border: 1px solid #000;
                            text-align: center;
                            font-size: 10px;
                        }
                        
                        .excel-table .row-number {
                            background: #D9E2F3;
                            font-weight: bold;
                            width: 30px;
                            text-align: center;
                        }
                        
                        .excel-table .total-row {
                            background: #FFF2CC;
                            font-weight: bold;
                            border-top: 2px solid #000;
                        }
                        
                        .excel-table .subtotal-row {
                            background: #E2EFDA;
                            font-weight: bold;
                        }
                        
                        .header-section {
                            background: linear-gradient(to right, #4472C4, #70AD47);
                            color: white;
                            padding: 15px;
                            margin-bottom: 20px;
                            border: 2px solid #000;
                            text-align: center;
                        }
                        
                        .header-section h1 {
                            margin: 0 0 8px 0;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        
                        .header-section p {
                            margin: 3px 0;
                            font-size: 12px;
                        }
                        
                        .summary-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            margin: 15px 0;
                        }
                        
                        .summary-card {
                            border: 2px solid #000;
                            padding: 10px;
                            text-align: center;
                            border-radius: 5px;
                        }
                        
                        .summary-card.debt {
                            background: linear-gradient(to bottom, #FFE6E6, #FFCCCC);
                        }
                        
                        .summary-card.payment {
                            background: linear-gradient(to bottom, #E6F7E6, #CCEECC);
                        }
                        
                        .summary-card.net {
                            background: linear-gradient(to bottom, #E6F3FF, #CCE7FF);
                        }
                        
                        .summary-card.count {
                            background: linear-gradient(to bottom, #FFF0E6, #FFE1CC);
                        }
                        
                        .summary-card h3 {
                            margin: 0 0 5px 0;
                            font-size: 10px;
                            color: #333;
                        }
                        
                        .summary-card .value {
                            font-size: 14px;
                            font-weight: bold;
                            margin: 5px 0;
                        }
                        
                        .summary-card .percentage {
                            font-size: 9px;
                            color: #666;
                        }
                        
                        .debt-value { color: #C5504B; }
                        .payment-value { color: #70AD47; }
                        .net-positive { color: #C5504B; }
                        .net-negative { color: #70AD47; }
                        .count-value { color: #4472C4; }
                        
                        .section-title {
                            background: linear-gradient(to right, #4472C4, #70AD47);
                            color: white;
                            padding: 8px 15px;
                            margin: 20px 0 10px 0;
                            font-weight: bold;
                            font-size: 12px;
                            border: 1px solid #000;
                        }
                        
                        .insights-box {
                            background: #F8F9FA;
                            border: 2px solid #4472C4;
                            padding: 10px;
                            margin: 15px 0;
                            border-radius: 5px;
                        }
                        
                        .insights-box h4 {
                            color: #4472C4;
                            margin: 0 0 8px 0;
                            font-size: 11px;
                        }
                        
                        .insights-box ul {
                            margin: 0;
                            padding-right: 15px;
                            font-size: 10px;
                        }
                        
                        .insights-box li {
                            margin-bottom: 3px;
                        }
                        
                        .footer-section {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 9px;
                            color: #666;
                            border-top: 2px solid #000;
                            padding-top: 10px;
                            background: #F8F9FA;
                        }
                        
                        .page-break {
                            page-break-before: always;
                        }
                        
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <!-- Header Section -->
                    <div class="header-section">
                        <h1>ğŸ’° Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„</h1>
                        <p><strong>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ - ${monthNames[month]} ${year}</strong></p>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-EG')} | Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</p>
                    </div>
                    
                    <!-- Executive Summary -->
                    <div class="section-title">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                    
                    <div class="summary-grid">
                        <div class="summary-card debt">
                            <h3>ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h3>
                            <div class="value debt-value">${totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            <div class="percentage">Ù†Ø³Ø¨Ø© Ù„Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${debtPercentage}%</div>
                        </div>
                        
                        <div class="summary-card payment">
                            <h3>ğŸ’š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø©</h3>
                            <div class="value payment-value">${totalPayments.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            <div class="percentage">Ù†Ø³Ø¨Ø© ØªØ­ØµÙŠÙ„: ${paymentPercentage}%</div>
                        </div>
                        
                        <div class="summary-card net">
                            <h3>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                            <div class="value ${netMovement >= 0 ? 'net-positive' : 'net-negative'}">${netMovement.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            <div class="percentage">${netMovement >= 0 ? 'Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'ØªØ­Ø³Ù† ÙÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„'}</div>
                        </div>
                        
                        <div class="summary-card count">
                            <h3>ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
                            <div class="value count-value">${transactionCount} Ù…Ø¹Ø§Ù…Ù„Ø©</div>
                            <div class="percentage">${activeCustomers} Ø¹Ù…ÙŠÙ„ Ù†Ø´Ø·</div>
                        </div>
                    </div>
                    
                    <!-- Key Insights -->
                    <div class="insights-box">
                        <h4>ğŸ” Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</h4>
                        <ul>
                            <li><strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø´Ø§Ø·:</strong> ${(transactionCount / 30).toFixed(1)} Ù…Ø¹Ø§Ù…Ù„Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·</li>
                            <li><strong>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©:</strong> ${activeCustomers > 0 ? (totalDebt / Math.max(monthlyTransactions.filter(t => t.type === 'debt').length, 1)).toFixed(2) : 0} Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</li>
                            <li><strong>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø©:</strong> ${activeCustomers > 0 ? (totalPayments / Math.max(monthlyTransactions.filter(t => t.type === 'payment').length, 1)).toFixed(2) : 0} Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</li>
                            <li><strong>ÙƒÙØ§Ø¡Ø© Ø§Ù„ØªØ­ØµÙŠÙ„:</strong> ${paymentPercentage}% Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª ØªÙ… ØªØ­ØµÙŠÙ„Ù‡Ø§</li>
                            ${netMovement > 0 ? '<li><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù‡Ù†Ø§Ùƒ Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© ØªØªØ·Ù„Ø¨ Ù…ØªØ§Ø¨Ø¹Ø©</li>' : '<li><strong>Ø¥ÙŠØ¬Ø§Ø¨ÙŠ:</strong> ØªØ­Ø³Ù† Ù…Ù„Ø­ÙˆØ¸ ÙÙŠ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</li>'}
                        </ul>
                    </div>
                    
                    ${activeCustomers > 0 ? `
                    <!-- Customer Activity Table -->
                    <div class="section-title">ğŸ‘¥ ØªÙØ§ØµÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (${activeCustomers} Ø¹Ù…ÙŠÙ„ Ù†Ø´Ø·)</div>
                    
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="row-number">#</th>
                                <th>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</th>
                                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø©</th>
                                <th>ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(customerActivity).map((code, index) => {
                                const activity = customerActivity[code];
                                const netAmount = activity.debt - activity.payments;
                                const status = netAmount > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : netAmount < 0 ? 'Ø¯Ø§Ø¦Ù†' : 'Ù…ØªÙˆØ§Ø²Ù†';
                                const statusColor = netAmount > 0 ? 'debt-value' : netAmount < 0 ? 'payment-value' : 'count-value';
                                
                                return `
                                    <tr>
                                        <td class="row-number">${index + 1}</td>
                                        <td>${code}</td>
                                        <td style="text-align: right;">${activity.name}</td>
                                        <td class="debt-value">${activity.debt.toFixed(2)}</td>
                                        <td class="payment-value">${activity.payments.toFixed(2)}</td>
                                        <td class="${statusColor}">${netAmount.toFixed(2)}</td>
                                        <td>${activity.transactions.length}</td>
                                        <td class="${statusColor}">${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</strong></td>
                                <td class="debt-value"><strong>${totalDebt.toFixed(2)}</strong></td>
                                <td class="payment-value"><strong>${totalPayments.toFixed(2)}</strong></td>
                                <td class="${netMovement >= 0 ? 'debt-value' : 'payment-value'}"><strong>${netMovement.toFixed(2)}</strong></td>
                                <td><strong>${transactionCount}</strong></td>
                                <td><strong>${activeCustomers} Ø¹Ù…ÙŠÙ„</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    ` : ''}
                    
                    ${monthlyTransactions.length > 0 ? `
                    <!-- Detailed Transactions -->
                    <div class="page-break"></div>
                    <div class="section-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (${monthlyTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©)</div>
                    
                    <table class="excel-table">
                        <thead>
                            <tr>
                                <th class="row-number">#</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬Ù†ÙŠÙ‡)</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlyTransactions.sort((a, b) => new Date(a.date) - new Date(b.date)).map((transaction, index) => {
                                const date = new Date(transaction.date);
                                const typeText = transaction.type === 'debt' ? 'Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©' : 'Ø¯ÙØ¹Ø©';
                                const typeClass = transaction.type === 'debt' ? 'debt-value' : 'payment-value';
                                const typeIcon = transaction.type === 'debt' ? 'ğŸ’¸' : 'ğŸ’š';
                                
                                return `
                                    <tr>
                                        <td class="row-number">${index + 1}</td>
                                        <td>${date.toLocaleDateString('ar-EG')}</td>
                                        <td>${date.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}</td>
                                        <td>${transaction.customerCode}</td>
                                        <td style="text-align: right;">${transaction.customerName}</td>
                                        <td class="${typeClass}">${typeIcon} ${typeText}</td>
                                        <td class="${typeClass}"><strong>${transaction.amount.toFixed(2)}</strong></td>
                                        <td style="text-align: right; font-size: 9px;">${transaction.description || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="subtotal-row">
                                <td colspan="6"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</strong></td>
                                <td class="debt-value"><strong>${totalDebt.toFixed(2)}</strong></td>
                                <td></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td colspan="6"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</strong></td>
                                <td class="payment-value"><strong>${totalPayments.toFixed(2)}</strong></td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="6"><strong>ØµØ§ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ©</strong></td>
                                <td class="${netMovement >= 0 ? 'debt-value' : 'payment-value'}"><strong>${netMovement.toFixed(2)}</strong></td>
                                <td><strong>${transactionCount} Ù…Ø¹Ø§Ù…Ù„Ø©</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    ` : `
                    <div class="insights-box">
                        <h4>ğŸ“… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙÙŠ ${monthNames[month]} ${year}</h4>
                        <ul>
                            <li>Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø§Ù„ÙŠØ© Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</li>
                            <li>ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</li>
                            <li>ÙŠÙ…ÙƒÙ† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</li>
                        </ul>
                    </div>
                    `}
                    
                    <!-- Footer -->
                    <div class="footer-section">
                        <p><strong>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</strong></p>
                        <p>ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„ | Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-EG')}</p>
                        <p>Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠ ÙˆÙ…Ø®ØµØµ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showSuccessMessage('ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹ Ø¨ØªØµÙ…ÙŠÙ… Excel Ø§Ù„Ù…Ø­ØªØ±Ù');
        }

        function createBackup() {
            const backupData = {
                customers: customers,
                transactions: transactions,
                backupDate: new Date().toISOString(),
                version: '7.1 - 2025'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            hideBackupReminder();
            
            showSuccessMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }

        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.customers && backupData.transactions) {
                            customers = backupData.customers;
                            transactions = backupData.transactions;
                            
                            localStorage.setItem('customersData', JSON.stringify(customers));
                            localStorage.setItem('transactionsData', JSON.stringify(transactions));
                            
                            updateStatistics();
                            renderCustomersList();
                            
                            fileInput.value = '';
                            showSuccessMessage('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                        } else {
                            alert('Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­');
                        }
                    } catch (error) {
                        alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                        console.error('Backup restore error:', error);
                    }
                };
                
                reader.readAsText(file);
            }
        }

        function exportToExcel() {
            if (Object.keys(customers).length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }

            showLoading();

            const excelData = [
                ['ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'],
                ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ' + new Date().toLocaleString('ar-EG')],
                [''],
                ['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©']
            ];

            Object.keys(customers).forEach(code => {
                const customer = customers[code];
                const status = customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯';
                
                excelData.push([
                    customer.code,
                    customer.name,
                    customer.phone || '',
                    customer.address || '',
                    customer.totalDebt,
                    customer.totalPaid,
                    customer.balance,
                    status
                ]);
            });

            const totalCustomers = Object.keys(customers).length;
            const totalDebt = Object.values(customers).reduce((sum, c) => sum + c.totalDebt, 0);
            const totalPaid = Object.values(customers).reduce((sum, c) => sum + c.totalPaid, 0);
            const debtorCount = Object.values(customers).filter(c => c.balance > 0).length;

            excelData.push(['']);
            excelData.push(['Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ']);
            excelData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', totalCustomers]);
            excelData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª', totalDebt]);
            excelData.push(['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª', totalPaid]);
            excelData.push(['Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†', debtorCount]);

            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');

            ws['!cols'] = [
                {wch: 12}, {wch: 20}, {wch: 15}, {wch: 25}, 
                {wch: 15}, {wch: 15}, {wch: 15}, {wch: 10}
            ];

            XLSX.writeFile(wb, `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            hideLoading();
            showSuccessMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­');
        }

        function downloadTemplate() {
            const templateData = [
                ['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'],
                ['C001', 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', '01234567890', 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', 'debt', '1500', 'ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… 001', '2024-01-15'],
                ['C002', 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', '01098765432', 'Ø§Ù„Ø¬ÙŠØ²Ø©', 'debt', '2000', 'Ù…Ø´ØªØ±ÙŠØ§Øª Ù…ØªÙ†ÙˆØ¹Ø©', '2024-01-16'],
                ['C001', '', '', '', 'payment', '500', 'Ø¯ÙØ¹Ø© Ø¬Ø²Ø¦ÙŠØ©', '2024-01-17'],
                ['', '', '', '', '', '', '', ''],
                ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:', '', '', '', '', '', '', ''],
                ['- ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„: Ù…Ø·Ù„ÙˆØ¨ Ù„ÙƒÙ„ Ù…Ø¹Ø§Ù…Ù„Ø©', '', '', '', '', '', '', ''],
                ['- Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: Ù…Ø·Ù„ÙˆØ¨ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯', '', '', '', '', '', '', ''],
                ['- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯', '', '', '', '', '', '', ''],
                ['- Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: debt Ù„Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©ØŒ payment Ù„Ù„Ø¯ÙØ¹Ø©', '', '', '', '', '', '', ''],
                ['- Ø§Ù„Ù…Ø¨Ù„Øº: Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„Ø©', '', '', '', '', '', '', ''],
                ['- Ø§Ù„ØªØ§Ø±ÙŠØ®: Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹', '', '', '', '', '', '', '']
            ];

            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©');
            
            ws['!cols'] = [
                {wch: 12}, {wch: 20}, {wch: 15}, {wch: 20},
                {wch: 15}, {wch: 10}, {wch: 25}, {wch: 15}
            ];

            XLSX.writeFile(wb, 'Ù†Ù…ÙˆØ°Ø¬_Ø§Ø³ØªÙŠØ±Ø§Ø¯_Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©.xlsx');
            showSuccessMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
        }

        function importFromExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            showLoading();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    processExcelData(jsonData);
                } catch (error) {
                    hideLoading();
                    alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ­ÙŠØ­ ÙˆÙ…Ù† Ù†ÙˆØ¹ Excel');
                    console.error('Excel import error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            if (data.length < 2) {
                hideLoading();
                alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                return;
            }

            let importedCount = 0;
            let errorCount = 0;
            const errors = [];

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                
                if (!row || row.length === 0 || !row[0]) continue;
                
                const customerCode = String(row[0]).trim().toUpperCase();
                const customerName = row[1] ? String(row[1]).trim() : '';
                const customerPhone = row[2] ? String(row[2]).trim() : '';
                const customerAddress = row[3] ? String(row[3]).trim() : '';
                const transactionType = row[4] ? String(row[4]).trim().toLowerCase() : '';
                const amount = row[5] ? parseFloat(row[5]) : 0;
                const description = row[6] ? String(row[6]).trim() : '';
                const dateStr = row[7] ? String(row[7]).trim() : '';

                if (!customerCode) {
                    errors.push(`Ø§Ù„ØµÙ ${i + 1}: ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨`);
                    errorCount++;
                    continue;
                }

                if (!customers[customerCode] && customerName) {
                    customers[customerCode] = {
                        code: customerCode,
                        name: customerName,
                        phone: customerPhone,
                        address: customerAddress,
                        totalDebt: 0,
                        totalPaid: 0,
                        balance: 0,
                        createdAt: new Date().toISOString()
                    };
                }

                if (transactionType && amount > 0) {
                    if (!customers[customerCode]) {
                        errors.push(`Ø§Ù„ØµÙ ${i + 1}: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨ÙƒÙˆØ¯ ${customerCode} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                        errorCount++;
                        continue;
                    }

                    if (transactionType !== 'debt' && transactionType !== 'payment') {
                        errors.push(`Ø§Ù„ØµÙ ${i + 1}: Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† debt Ø£Ùˆ payment`);
                        errorCount++;
                        continue;
                    }

                    if (isNaN(amount) || amount <= 0) {
                        errors.push(`Ø§Ù„ØµÙ ${i + 1}: Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨`);
                        errorCount++;
                        continue;
                    }

                    const transaction = {
                        id: Date.now() + i,
                        customerCode: customerCode,
                        customerName: customers[customerCode].name,
                        type: transactionType,
                        amount: amount,
                        description: description,
                        date: dateStr || new Date().toISOString(),
                        timestamp: new Date().toLocaleString('ar-EG'),
                        imported: true
                    };

                    if (transactionType === 'debt') {
                        customers[customerCode].totalDebt += amount;
                        customers[customerCode].balance += amount;
                    } else if (transactionType === 'payment') {
                        customers[customerCode].totalPaid += amount;
                        customers[customerCode].balance -= amount;
                        if (customers[customerCode].balance < 0) {
                            customers[customerCode].balance = 0;
                        }
                    }

                    transactions.push(transaction);
                }
                
                importedCount++;
            }

            localStorage.setItem('customersData', JSON.stringify(customers));
            localStorage.setItem('transactionsData', JSON.stringify(transactions));

            updateStatistics();
            renderCustomersList();
            hideLoading();

            document.getElementById('excelFile').value = '';

            let message = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedCount} Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­`;
            if (errorCount > 0) {
                message += `\nØªÙ… ØªØ¬Ø§Ù‡Ù„ ${errorCount} ØµÙ Ø¨Ø³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡`;
                if (errors.length > 0) {
                    console.log('Import errors:', errors);
                    alert(message + '\n\nØ§Ù„Ø£Ø®Ø·Ø§Ø¡:\n' + errors.slice(0, 5).join('\n') + 
                          (errors.length > 5 ? '\n... ÙˆØ§Ù„Ù…Ø²ÙŠØ¯' : ''));
                } else {
                    alert(message);
                }
            } else {
                showSuccessMessage(message);
            }
        }

        // Customers Management Page Functions
        function showCustomersPage() {
            document.getElementById('customersPage').classList.remove('hidden');
            renderCustomersPage();
            setupCustomersPageEventListeners();
        }

        function hideCustomersPage() {
            document.getElementById('customersPage').classList.add('hidden');
            selectedCustomers.clear();
        }

        function setupCustomersPageEventListeners() {
            document.getElementById('customersPageSearch').addEventListener('input', filterCustomersPage);
            document.getElementById('customersPageFilter').addEventListener('change', filterCustomersPage);
            document.getElementById('customersPageSort').addEventListener('change', renderCustomersPage);
        }

        function renderCustomersPage() {
            const container = document.getElementById('customersPageList');
            const customerCodes = Object.keys(customers);
            
            if (customerCodes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">ğŸ‘¥</div>
                        <p class="text-xl">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                        <p class="text-sm mt-2">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                    </div>
                `;
                updateCustomersPageStats();
                return;
            }

            const sortBy = document.getElementById('customersPageSort').value;
            customerCodes.sort((a, b) => {
                const customerA = customers[a];
                const customerB = customers[b];
                
                switch(sortBy) {
                    case 'name':
                        return customerA.name.localeCompare(customerB.name, 'ar');
                    case 'code':
                        return customerA.code.localeCompare(customerB.code);
                    case 'balance':
                        return customerB.balance - customerA.balance;
                    case 'date':
                        return new Date(customerB.createdAt) - new Date(customerA.createdAt);
                    default:
                        return 0;
                }
            });

            const customersHTML = customerCodes.map(code => {
                const customer = customers[code];
                const statusColor = customer.balance > 0 ? 'text-red-600' : 'text-green-600';
                const statusIcon = customer.balance > 0 ? 'âš ï¸' : 'âœ…';
                const statusText = customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯';
                const isSelected = selectedCustomers.has(code);

                return `
                    <div class="customer-card border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200 ${isSelected ? 'bg-blue-50 border-blue-300' : ''}" 
                         data-code="${code}" data-name="${customer.name.toLowerCase()}" data-balance="${customer.balance}">
                        <div class="flex items-start gap-4">
                            <div class="flex items-center pt-1">
                                <input type="checkbox" id="customer_${code}" 
                                       class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleCustomerSelection('${code}')">
                            </div>
                            
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <h3 class="text-lg font-semibold text-gray-800">${customer.name}</h3>
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">${customer.code}</span>
                                    <span class="${statusColor} text-lg">${statusIcon}</span>
                                </div>
                                
                                ${customer.phone ? `<p class="text-sm text-gray-600 mb-1 flex items-center"><span class="ml-2">ğŸ“</span>${customer.phone}</p>` : ''}
                                ${customer.address ? `<p class="text-sm text-gray-600 mb-3 flex items-center"><span class="ml-2">ğŸ“</span>${customer.address}</p>` : ''}
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="text-center bg-red-50 rounded-lg p-2">
                                        <p class="text-gray-600 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</p>
                                        <p class="font-bold text-red-600">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div class="text-center bg-green-50 rounded-lg p-2">
                                        <p class="text-gray-600 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                        <p class="font-bold text-green-600">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div class="text-center bg-gray-50 rounded-lg p-2">
                                        <p class="text-gray-600 text-xs">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                                        <p class="font-bold ${statusColor}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</p>
                                    </div>
                                    <div class="text-center bg-blue-50 rounded-lg p-2">
                                        <p class="text-gray-600 text-xs">Ø§Ù„Ø­Ø§Ù„Ø©</p>
                                        <p class="font-bold ${statusColor}">${statusText}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <button onclick="showCustomerHistory('${code}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                    <span class="ml-1">ğŸ“Š</span>
                                    Ø§Ù„Ø³Ø¬Ù„
                                </button>
                                <button onclick="deleteCustomerFromPage('${code}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition duration-200 flex items-center">
                                    <span class="ml-1">ğŸ—‘ï¸</span>
                                    Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = customersHTML;
            updateCustomersPageStats();
        }

        function toggleCustomerSelection(customerCode) {
            if (selectedCustomers.has(customerCode)) {
                selectedCustomers.delete(customerCode);
            } else {
                selectedCustomers.add(customerCode);
            }
            
            updateSelectedCount();
            updateCustomerCardAppearance(customerCode);
        }

        function updateCustomerCardAppearance(customerCode) {
            const card = document.querySelector(`[data-code="${customerCode}"]`);
            const checkbox = document.getElementById(`customer_${customerCode}`);
            
            if (selectedCustomers.has(customerCode)) {
                card.classList.add('bg-blue-50', 'border-blue-300');
                checkbox.checked = true;
            } else {
                card.classList.remove('bg-blue-50', 'border-blue-300');
                checkbox.checked = false;
            }
        }

        function selectAllCustomers() {
            const visibleCards = document.querySelectorAll('.customer-card:not([style*="display: none"])');
            visibleCards.forEach(card => {
                const customerCode = card.getAttribute('data-code');
                selectedCustomers.add(customerCode);
                updateCustomerCardAppearance(customerCode);
            });
            updateSelectedCount();
        }

        function deselectAllCustomers() {
            selectedCustomers.clear();
            document.querySelectorAll('.customer-card').forEach(card => {
                const customerCode = card.getAttribute('data-code');
                updateCustomerCardAppearance(customerCode);
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedCustomers.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('customersPageSelectedCount').textContent = count;
        }

        function updateCustomersPageStats() {
            const customerCodes = Object.keys(customers);
            const totalCount = customerCodes.length;
            let debtorCount = 0;
            let clearedCount = 0;

            customerCodes.forEach(code => {
                const customer = customers[code];
                if (customer.balance > 0) {
                    debtorCount++;
                } else {
                    clearedCount++;
                }
            });

            document.getElementById('customersPageTotalCount').textContent = totalCount;
            document.getElementById('customersPageDebtorCount').textContent = debtorCount;
            document.getElementById('customersPageClearedCount').textContent = clearedCount;
        }

        function filterCustomersPage() {
            const searchTerm = document.getElementById('customersPageSearch').value.toLowerCase();
            const filterValue = document.getElementById('customersPageFilter').value;
            
            const customerCards = document.querySelectorAll('.customer-card');
            
            customerCards.forEach(card => {
                const customerName = card.getAttribute('data-name');
                const customerCode = card.getAttribute('data-code').toLowerCase();
                const balance = parseFloat(card.getAttribute('data-balance'));
                
                let showCard = true;
                
                if (searchTerm && !customerName.includes(searchTerm) && !customerCode.includes(searchTerm)) {
                    showCard = false;
                }
                
                if (filterValue === 'debtors' && balance <= 0) {
                    showCard = false;
                } else if (filterValue === 'cleared' && balance > 0) {
                    showCard = false;
                }
                
                card.style.display = showCard ? 'block' : 'none';
            });
        }

        function deleteCustomerFromPage(customerCode) {
            const customer = customers[customerCode];
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer.name}" (${customerCode}) ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ØŸ`)) {
                delete customers[customerCode];
                transactions = transactions.filter(t => t.customerCode !== customerCode && t.customerName !== customer.name);
                
                localStorage.setItem('customersData', JSON.stringify(customers));
                localStorage.setItem('transactionsData', JSON.stringify(transactions));
                
                selectedCustomers.delete(customerCode);
                updateStatistics();
                renderCustomersPage();
                showSuccessMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        function deleteSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedCustomers.size} Ø¹Ù…ÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡Ù…ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) {
                showLoading();
                
                selectedCustomers.forEach(customerCode => {
                    delete customers[customerCode];
                    transactions = transactions.filter(t => t.customerCode !== customerCode);
                });
                
                localStorage.setItem('customersData', JSON.stringify(customers));
                localStorage.setItem('transactionsData', JSON.stringify(transactions));
                
                const deletedCount = selectedCustomers.size;
                selectedCustomers.clear();
                
                updateStatistics();
                renderCustomersPage();
                hideLoading();
                showSuccessMessage(`ØªÙ… Ø­Ø°Ù ${deletedCount} Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
            }
        }

        function exportSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ØªØµØ¯ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            showLoading();

            const excelData = [
                ['ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡'],
                ['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ' + new Date().toLocaleString('ar-EG')],
                ['Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†: ' + selectedCustomers.size],
                [''],
                ['ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹', 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©']
            ];

            selectedCustomers.forEach(code => {
                const customer = customers[code];
                const status = customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯';
                
                excelData.push([
                    customer.code,
                    customer.name,
                    customer.phone || '',
                    customer.address || '',
                    customer.totalDebt,
                    customer.totalPaid,
                    customer.balance,
                    status
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†');

            ws['!cols'] = [
                {wch: 12}, {wch: 20}, {wch: 15}, {wch: 25}, 
                {wch: 15}, {wch: 15}, {wch: 15}, {wch: 10}
            ];

            XLSX.writeFile(wb, `Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡_Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            hideLoading();
            showSuccessMessage(`ØªÙ… ØªØµØ¯ÙŠØ± ${selectedCustomers.size} Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰ Excel Ø¨Ù†Ø¬Ø§Ø­`);
        }

        function printSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const printWindow = window.open('', '_blank');
            let printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ† - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            margin: 20px;
                            color: #333;
                            direction: rtl;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #2563eb;
                            margin: 0;
                            font-size: 24px;
                        }
                        .customer {
                            border: 1px solid #ddd;
                            margin-bottom: 15px;
                            padding: 15px;
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        .customer h3 {
                            margin: 0 0 10px 0;
                            color: #333;
                            font-size: 18px;
                        }
                        .customer-info {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 10px;
                            margin-top: 10px;
                        }
                        .info-item {
                            text-align: center;
                            padding: 8px;
                            border: 1px solid #eee;
                            border-radius: 4px;
                        }
                        .info-item p {
                            margin: 0;
                            font-size: 12px;
                            color: #666;
                        }
                        .info-item .value {
                            font-weight: bold;
                            font-size: 14px;
                            margin-top: 5px;
                        }
                        .red { color: #dc2626; }
                        .green { color: #16a34a; }
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                            border-top: 1px solid #ddd;
                            padding-top: 20px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</h1>
                        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - ÙØ±Ø¹ Ø§Ù„Ø³Ø§Ø­Ù„</p>
                        <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString('ar-EG')}</p>
                        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${selectedCustomers.size}</p>
                    </div>
            `;

            selectedCustomers.forEach(code => {
                const customer = customers[code];
                const statusColor = customer.balance > 0 ? 'red' : 'green';
                const statusText = customer.balance > 0 ? 'Ù…Ø¯ÙŠÙˆÙ†' : 'Ù…Ø³Ø¯Ø¯';

                printContent += `
                    <div class="customer">
                        <h3>${customer.name} (${customer.code})</h3>
                        ${customer.phone ? `<p>ğŸ“ ${customer.phone}</p>` : ''}
                        ${customer.address ? `<p>ğŸ“ ${customer.address}</p>` : ''}
                        
                        <div class="customer-info">
                            <div class="info-item">
                                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©</p>
                                <div class="value red">${customer.totalDebt.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            <div class="info-item">
                                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</p>
                                <div class="value green">${customer.totalPaid.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            <div class="info-item">
                                <p>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                                <div class="value ${statusColor}">${customer.balance.toFixed(2)} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            <div class="info-item">
                                <p>Ø§Ù„Ø­Ø§Ù„Ø©</p>
                                <div class="value ${statusColor}">${statusText}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            printContent += `
                    <div class="footer">
                        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± 7.1</p>
                        <p>Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showSuccessMessage(`ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© ${selectedCustomers.size} Ø¹Ù…ÙŠÙ„`);
        }

        function showSuccessMessage(message) {
            const messageEl = document.getElementById('successMessage');
            const textEl = document.getElementById('successText');
            
            textEl.textContent = message;
            messageEl.classList.remove('hidden');
            messageEl.classList.add('success-animation');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
                messageEl.classList.remove('success-animation');
            }, 3000);
        }

        // Close modal when clicking outside
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                createBackup();
            }
            
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98b63f3a3623a10c',t:'MTc1OTkzMjg5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
